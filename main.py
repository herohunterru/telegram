import os
import asyncio
import google.generativeai as genai
import telegram

# --- –ù–û–í–ê–Ø –ß–ê–°–¢–¨: –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π ---
# –ú—ã –≤—ã–Ω–µ—Å–ª–∏ –≤—Å–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –≤ —Å–ø–∏—Å–æ–∫. –°–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å –æ–¥–Ω—É –ø–æ –ø–æ—Ä—è–¥–∫—É.
PROFESSIONS = [
    "–î–∏—Ä–µ–∫—Ç–æ—Ä –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –∫–æ–º–º–µ—Ä—Ü–∏–∏", "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º–∏",
    "–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ —Ä–∞–±–æ—Ç–µ —Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º–∏", "–ê–∫–∫–∞—É–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤",
    "–ö–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä", "–ê–Ω–∞–ª–∏—Ç–∏–∫ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤", "E-commerce –∞–Ω–∞–ª–∏—Ç–∏–∫",
    "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö", "–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ —Ç—Ä–∞—Ñ–∏–∫—É",
    "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é", "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥", "–ë—Ä–µ–Ω–¥-–º–µ–Ω–µ–¥–∂–µ—Ä",
    "SEO-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "SMM-–º–µ–Ω–µ–¥–∂–µ—Ä", "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —Å–∫–ª–∞–¥–∞", "–ù–∞—á–∞–ª—å–Ω–∏–∫ –æ—Ç–¥–µ–ª–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏",
    "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —Ñ—É–ª—Ñ–∏–ª–º–µ–Ω—Ç—É", "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ç–æ–≤–∞—Ä–Ω—ã–º–∏ –∑–∞–ø–∞—Å–∞–º–∏",
    "–ö–ª–∞–¥–æ–≤—â–∏–∫", "–°–±–æ—Ä—â–∏–∫ –∑–∞–∫–∞–∑–æ–≤", "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–µ",
    "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä / –ê–Ω–∞–ª–∏—Ç–∏–∫", "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä", "–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ —Ä–∞–±–æ—Ç–µ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏",
    "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏", "–ö–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä", "–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –∑–∞–∫—É–ø–∫–∞–º",
    "–Æ—Ä–∏—Å—Ç", "–ú–µ–Ω–µ–¥–∂–µ—Ä ozon", "–ú–µ–Ω–µ–¥–∂–µ—Ä wildberries", "–¥–∏—Ä–µ–∫—Ç–æ—Ä –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É"
]

def get_gemini_response(api_key, prompt):
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç —É Gemini."""
    try:
        print("1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É—é Gemini API...")
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel('gemini-pro')
        
        print(f"2. –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –≤ Gemini...")
        response = model.generate_content(prompt)
        
        if response.text:
            print("3. –û—Ç–≤–µ—Ç –æ—Ç Gemini —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω.")
            return response.text.strip()
        else:
            print("–û—à–∏–±–∫–∞: Gemini –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç.")
            return None
            
    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Gemini API: {e}")
        return None

async def post_to_telegram(bot_token, channel_id, text_to_post):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram-–∫–∞–Ω–∞–ª."""
    if not text_to_post:
        print("–¢–µ–∫—Å—Ç –¥–ª—è –ø–æ—Å—Ç–∞ –ø—É—Å—Ç–æ–π. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return False
    
    try:
        print("4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é Telegram-–±–æ—Ç–∞...")
        bot = telegram.Bot(token=bot_token)
        
        print(f"5. –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª {channel_id}...")
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º HTML –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫
        await bot.send_message(
            chat_id=channel_id,
            text=text_to_post,
            parse_mode='HTML' 
        )
        print("6. –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!")
        return True
        
    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram: {e}")
        return False

async def main():
    """–ì–ª–∞–≤–Ω–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å."""
    gemini_key = os.getenv("GEMINI_API_KEY")
    bot_token = os.getenv("TELEGRAM_BOT_TOKEN")
    channel_id = os.getenv("TELEGRAM_CHANNEL_ID")
    
    # --- –ù–û–í–ê–Ø –ß–ê–°–¢–¨: –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ –æ—Ç GitHub Actions ---
    # –≠—Ç–æ –Ω–∞—à —Å–ø–æ—Å–æ–± "–ø–æ–º–Ω–∏—Ç—å", –∫–∞–∫–æ–π –ø–æ—Å—Ç –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–º.
    run_number_str = os.getenv("GITHUB_RUN_NUMBER", "1")
    run_number = int(run_number_str)
    
    # –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞, —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥—è –∫ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
    profession_index = (run_number - 1) % len(PROFESSIONS)
    selected_profession = PROFESSIONS[profession_index]
    print(f"–ù–æ–º–µ—Ä –∑–∞–ø—É—Å–∫–∞: {run_number}. –í—ã–±—Ä–∞–Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è: '{selected_profession}'")


    if not all([gemini_key, bot_token, channel_id]):
        print("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω—ã –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã...")
        return

    # --- –ù–û–í–ê–Ø –ß–ê–°–¢–¨: –í–ê–® –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –ü–†–û–ú–ü–¢ ---
    # –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º f-string (f"...") –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –ø—Ä—è–º–æ –≤ —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞.
    prompt = f"""
–†–û–õ–¨: HR-—ç–∫—Å–ø–µ—Ä—Ç –∏ –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –¥–ª—è Telegram.
–°–¢–ò–õ–¨: –ö—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –±–µ–∑ –≤–æ–¥—ã, —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.
–ó–ê–î–ê–ß–ê: –ù–∞–ø–∏—Å–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π HR-–∫–µ–π—Å.
–ü–†–ê–í–ò–õ–ê: –ü–æ—Å—Ç —Å—Ç—Ä–æ–≥–æ –¥–æ 700 —Å–∏–º–≤–æ–ª–æ–≤, 3-5 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —ç–º–æ–¥–∑–∏, –±–µ–∑ —Å–ø–∏—Å–∫–æ–≤/–º–∞—Ä–∫–µ—Ä–æ–≤.

–®–ê–ì 1: –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏—é: {selected_profession}.

–®–ê–ì 2: –ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç —Å—Ç—Ä–æ–≥–æ –ø–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ (–∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):
–ó–∞–≥–æ–ª–æ–≤–æ–∫: (—è—Ä–∫–∏–π, —Å "–ú–æ—Å–∫–≤–∞" –∏ —Å—É—Ç—å—é –∫–µ–π—Å–∞ üéØ)
–ü—Ä–æ–±–ª–µ–º–∞: (–æ–ø–∏—Å–∞–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ü§î)
–†–µ—à–µ–Ω–∏–µ: (—Å—É—Ç—å "—Ñ–∏—à–∫–∏" üí°)
–í—ã–≤–æ–¥: (—Ä–µ–∑—é–º–µ –∏ —Å–æ–≤–µ—Ç üìå)
CTA: (–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–∏–∑—ã–≤ —Å —Å–∞–π—Ç–æ–º <a href="https://herohunter.ru">herohunter.ru</a>)
"""
    
    # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∏–¥–µ—é –¥–ª—è –ø–æ—Å—Ç–∞ –æ—Ç Gemini
    post_text = get_gemini_response(gemini_key, prompt)
    
    # –®–∞–≥ 2: –ü—É–±–ª–∏–∫—É–µ–º –∏–¥–µ—é –≤ Telegram
    if post_text:
        await post_to_telegram(bot_token, channel_id, post_text)

if __name__ == "__main__":
    asyncio.run(main())
